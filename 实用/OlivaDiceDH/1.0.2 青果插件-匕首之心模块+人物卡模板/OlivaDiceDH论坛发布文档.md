# 匕首之心模块（Daggerheart跑团专用插件+人物卡模板）

> **特别致谢**：本插件在开发过程中参考了 [RidRisR](https://github.com/RidRisR) 为海豹骰子开发的 Daggerheart 二元骰插件。  
> 海豹插件仓库地址：[DaggerHeart-CharacterSheet](https://github.com/RidRisR/DaggerHeart-CharacterSheet/blob/main/public/配套骰子（适用于海豹骰子）/daggerheart.js)  

---

- **名称**​：匕首之心模块（Daggerheart Module）
- ​**作者**​：Desom-fu
- ​**版本**​：1.0.2
- ​**兼容版本**​：理论兼容所有版本，但仅在最新版本测试过
- ​**平台**​：理论支持全平台（仅在 QQ 部署测试过）
- ​**操作系统**​：理论支持全系统（仅在 Windows Server 2019 上部署过）
- **前置插件**：OlivaDiceCore

---

## 注意事项

- 建议使用最新构建版`OlivaDice`以获得最佳体验
- （记得解压！）
[upl-file uuid=cbd142e9-1be0-4bb9-bc5c-46ee2c011518 size=669kB]ovo-all.zip[/upl-file]

- 下载完毕后建议打开`OlivaDice 设置面板`的自定义回复，在回复词中的`配置恢复模块`里面新增一行`OlivaDiceDH`（注意大小写要完全一致!）

---

## 下载

- ###### ​**插件包（记得解压！）** ​:
[upl-file uuid=dbad572e-cee8-44f8-a285-d3dcd8b95178 size=19kB]olivadicedh.zip[/upl-file]

- ###### **匕首之心青果专用人物卡模板（解压！）** :
[upl-file uuid=86056bee-408f-4656-9459-a47bda327018 size=1kB]dh.zip[/upl-file]

---

## 更新日志
## 2025.11.11 V1.0.2 更新
- 难度dc除去支持#难度，还支持[难度]格式，进行兼容
- 当希望值满的时候显示已达上限

## 2025.11.11 V1.0.1 更新
- 无人物卡时不再报错，而是自动创建一个以user_name为名字的新人物卡

## 2025.11.11 v1.0.0发布：
- 匕首之心插件首版发布
- 支持完整的二元骰检定系统
- 实现希望点和恐惧点机制
- 支持GM管理和恐惧点自动分配
- 内置烹饪小游戏
- 支持属性、经历、优势/劣势等多种修饰符
- 支持玩家互助检定系统
- 自动更新希望、压力、恐惧等属性

---

## 使用方法

1. 下载插件包并且解压后，将插件放到 `YourOlivOSPath\plugin\app` 这个路径里
2. 下载人物卡模板并且解压后，将人物卡模板放到 `YourOlivOSPath\plugin\data\OlivaDice\unity\extend\template` 这个路径里
3. 重载插件
4. 可在GUI里面自定义回复

---

## 核心功能

### 命令总览

#### 检定系统
- `.dd [骰面] [修饰符] [原因]` - 二元骰检定（主动检定）
- `.ddr [骰面] [修饰符] [原因]` - 反应二元骰检定（被动反应）

#### GM管理
- `.gm` - 设置/查看GM
- `.gm del` - 卸任GM
- `.gm clr/clear` - 清除所有GM记录

#### 娱乐功能
- `.cook [ndm]+[ndm]+...` - 开始烹饪游戏
- `.cook rm [骰面]` - 移除骰子继续游戏

#### 帮助文档
- `.help dh/匕首之心` - 查看总帮助
- `.help dd` - 查看二元骰检定详细说明
- `.help ddr` - 查看反应检定详细说明
- `.help gm` - 查看GM管理详细说明
- `.help cook` - 查看烹饪游戏详细说明
- `.help dhst` - 查看数据录入帮助

---

## 功能详解

### 1. 二元骰检定系统 (.dd)

**命令格式**：`.dd [n/m] [修饰符...] [原因]`

**核心机制**：
- 投掷1个希望骰(默认d12)和1个恐惧骰(默认d12)
- 比较希望骰和恐惧骰的大小关系
- 根据检定结果自动更新希望点、恐惧点、压力值等

**骰子面数设置**：
- `n/m` - 希望骰n面/恐惧骰m面（如：`12/20`表示d12希望骰和d20恐惧骰）
- `n/` - 只设置希望骰面数，恐惧骰默认12面
- `/m` - 只设置恐惧骰面数，希望骰默认12面
- 不填则默认`12/12`

**修饰符类型**：

1. **属性修饰符**（不消耗希望）
   - `+属性名` / `-属性名` - 使用人物卡中的属性值
   - 示例：`+敏捷`、`+力量`、`-闪避`
   - 支持所有人物卡模板中定义的技能和属性

2. **经历修饰符**（消耗1点希望）
   - `+经历名` / `-经历名` - 使用人物卡中的具名经历
   - `+经历[N]` / `+[N]经历` - 匿名经历，默认+2
   - 示例：`+锻造`、`+经历3`、`+2经历`
   - 每个经历修饰符需要消耗1点希望

3. **优势/劣势骰**（不消耗希望）
   - `+[N]优势` / `+[N]adv` - 投N个d6取最高值
   - `-[N]劣势` / `-[N]dis` - 投N个d6取最高值后取负
   - 示例：`+2优势`、`-劣势`、`+3adv`
   - 优势劣势可以相互抵消

4. **额外骰子**（不消耗希望）
   - `+[N]d[M]` / `-[N]d[M]` - 投掷额外骰子
   - 示例：`+2d6`、`-1d4`

5. **常量修饰符**（不消耗希望）
   - `+N` / `-N` - 直接加减常量
   - 示例：`+5`、`-3`

6. **玩家互助**（消耗帮助者的希望）
   - `@玩家名` - 其他玩家提供帮助
   - 每位帮助者消耗1点希望，提供1个优势骰
   - 最多可以有5位玩家帮助
   - 示例：`@Alice @Bob`

7. **难度设置**
   - `#[N]` - 设定检定难度（井号格式）
   - `[N]` - 设定检定难度（方括号格式）
   - 示例：`#15` 或 `[15]`

**检定结果判定**：

1. **希望骰 = 恐惧骰**：**大成功**
   - 显示："希望战胜了恐惧！光明指引着前路。"（随机变体）
   - 希望点 +1（如已达上限则不增加）
   - 压力值 -1（如果压力>0，否则显示"压力已为0"）
   - 如果有难度：视为成功

2. **希望骰 > 恐惧骰**：**希望结果**
   - 显示："希望战胜了恐惧！光明指引着前路。"（随机变体）
   - 希望点 +1（如已达上限则不增加）
   - 如果有难度：根据总点数判断成功/失败

3. **希望骰 < 恐惧骰**：**恐惧结果**
   - 显示："恐惧笼罩了希望...阴霾降临。"（随机变体）
   - GM恐惧点 +1（自动分配给本群所有GM）
   - 如果有难度：根据总点数判断成功/失败

**希望点消耗机制**：
- 使用具名经历：每个消耗1点希望
- 使用匿名经历：每个消耗1点希望
- 希望点不足时会跳过对应修饰符，并发出警告
- 优先消耗希望，然后再根据检定结果增加希望

**使用示例**：
```
.dd +敏捷 推门
  → 使用敏捷属性进行推门检定

.dd 12/20 +力量+2优势 #15 破门而入
  → d12希望骰，d20恐惧骰，加上力量和2个优势骰，难度15（#格式）

.dd +力量 [12] 破坏障碍
  → 使用力量检定，难度12（[]格式）

.dd +锻造-劣势 @Alice 修理武器
  → 使用锻造经历(消耗1点希望)，有1个劣势，Alice帮助(消耗Alice的1点希望)

.dd +敏捷+2d6+5 [10] 快速闪避
  → 敏捷+投2d6+5的常量修饰，难度10

.dd +力量+经历2 #20 举起巨石
  → 力量+匿名经历(+2，消耗1点希望)，难度20
```

---

### 2. 反应二元骰检定 (.ddr)

**命令格式**：`.ddr [n/m] [修饰符...] [原因]`

**功能说明**：
- 与`.dd`命令完全相同的检定机制和修饰符系统
- **关键区别**：
  - ✅ **仍会消耗希望**：使用经历时照常消耗希望点
  - ❌ **不增加希望**：检定结果不会增加希望点（即使希望结果或大成功）
  - ❌ **不增加GM恐惧**：检定结果不会增加GM恐惧点（即使恐惧结果）
  - ❌ **不减少压力**：大成功时也不会减少压力值
- 适用于反应性、被动性的检定场景

**使用场景**：
- 对抗检定的反应方
- 被动防御
- 反射性动作
- 不希望影响希望/恐惧池的检定

**使用示例**：
```
.ddr +闪避 躲避飞箭
  → 被动闪避检定，不增加希望点

.ddr +本能+优势 #12 察觉陷阱
  → 反应检定，即使成功也不增加希望

.ddr +锻造 修理盾牌
  → 使用锻造经历（消耗1点希望），但检定结果不增加希望
```

---

### 3. GM管理系统 (.gm)

#### 设置GM
**命令格式**：`.gm`

**功能说明**：
- 将当前用户设置为本群GM
- 自动创建专用GM人物卡（格式：`群哈希_dhgm_用户名`）
- 自动切换到GM人物卡并套用`dhgm`模板
- GM人物卡包含恐惧点、恐惧上限等属性
- 一个群可以有多个GM

#### 卸任GM
**命令格式**：`.gm del` / `.gm delete` / `.gm remove`

**功能说明**：
- 卸任当前用户的本群GM职位
- 保留GM人物卡数据

#### 清除所有GM
**命令格式**：`.gm clr` / `.gm clear`

**功能说明**：
- 清除本群所有GM记录
- 通常用于重置群组配置

#### GM恐惧点机制
**自动触发条件**：
- 当玩家使用`.dd`命令投出**恐惧结果**（希望骰 < 恐惧骰）时
- 自动给本群所有GM的恐惧点 +1
- 恐惧点有上限限制（默认12点）

**显示效果**：
```
[GM名称]的恐惧点: 5(5/12)=4+1(恐惧结果)
```

---

### 4. 烹饪游戏 (.cook)

#### 开始游戏
**命令格式**：`.cook [ndm]+[ndm]+...`

**参数说明**：
- 使用标准骰子表达式，用`+`连接
- 支持省略骰子数量（如`d6`等同于`1d6`）
- 示例：`.cook 3d6+2d4+d12`

#### 移除骰子
**命令格式**：`.cook rm [骰面]`

**参数说明**：
- `[骰面]`：要移除的骰子面数
- 支持格式：`10`、`d10`、`D10`
- 示例：`.cook rm 6`、`.cook rm d12`

#### 游戏规则

1. **投掷阶段**
   - 投掷所有指定的骰子
   - 显示所有骰子的结果

2. **配对阶段**
   - 相同点数的骰子可以两两配对
   - 每对骰子得分 = 骰子点数
   - 示例：两个3配对得3分，两个6配对得6分

3. **移除阶段**
   - 从未配对的骰子中选择一个移除
   - 剩余骰子重新投掷
   - 重复配对→移除流程

4. **结束条件**
   - 剩余 ≤2 个骰子时游戏结束
   - 如果最后2个骰子点数相同，可以配对得分
   - 否则游戏结束，无法继续

5. **得分评价**
   - **< 4分**：低分评价
     - "感觉分量有点少..."
     - "嗯...很独特的味道..."
   - **4-10分**：中等评价
     - "🎉 大餐完成了！"
     - "🎉 佳肴出炉！"
   - **> 10分**：高分评价
     - "🌟 杰作！这简直是艺术品！"
     - "🌟 完美的料理！太棒了！"

#### 游戏示例

```
用户：.cook 3d6+2d4

系统：【烹饪开始！】
出目：
[d6:5] [d6:3] [d6:3] [d4:2] [d4:4]
-----------------
【第1轮】
✓ 配对成功：1组
• (3, 3) → +3分
✗ 未配对：3颗
[d6:5] [d4:2] [d4:4]
当前风味：3分
-----------------
使用 .cook rm [骰面] 移除骰子继续
可移除：d6, d4

用户：.cook rm 6

系统：已移除：[d6:5]
剩余2颗骰子重新投掷：
[d4:1] [d4:2]
-----------------
【第2轮】
✓ 配对成功：0组
✗ 未配对：2颗
[d4:1] [d4:2]
当前风味：3分（累计）
-----------------
使用 .cook rm [骰面] 移除骰子继续
可移除：d4

用户：.cook rm d4

系统：已移除：[d4:1]
剩余1颗骰子重新投掷：
[d4:3]
-----------------
【第3轮】
✓ 配对成功：0组
✗ 配对失败，骰子已用尽
-----------------
最终风味：3分
感觉分量有点少...
```

---

## 人物卡系统

### 数据录入流程

1. **设置模板**（群组首次使用）
   ```
   .set temp dh
   ```

2. **开启自动名片**（玩家和GM均需执行）
   ```
   .sn auto on
   ```

3. **GM设置**
   ```
   .gm
   ```

4. **录入人物卡数据**
   ```
   .st 角色名-技能名1 技能值1 技能名2 技能值2 ...
   ```

5. **更新名片格式**
   ```
   .sn 或 .sn template
   ```

### 人物卡属性

#### 基础属性
- **生命/生命上限**：角色的生命值（默认上限6）
- **压力/压力上限**：压力值（默认上限6）
- **希望/希望上限**：希望点（默认上限6）
- **护甲/护甲上限**：防护值
- **恐惧/恐惧上限**：恐惧点（GM专用，默认上限12）
- **阈值**：重伤阈值
- **严重阈值**：严重伤害阈值

#### 技能属性
- **敏捷**（Agility）：灵活性和速度
- **力量**（Strength）：力量和耐力
- **本能**（Instinct）：直觉和感知
- **知识**（Knowledge）：学识和智慧
- **风度**（Presence）：魅力和影响力
- **灵巧**（Finesse）：精细操作和技巧
- **闪避**（Evasion）：回避能力

#### 自定义属性
- 所有不在模板skill列表中的属性均视为**经历**
- 使用经历作为修饰符时需要**消耗1点希望**

### 属性同义词系统

插件支持多种输入方式，以下输入均等效：

| 属性 | 同义词 |
|------|--------|
| 敏捷 | agility, agi, 敏, mj |
| 力量 | strength, str, 力, ll |
| 本能 | instinct, ins, 本, bn |
| 知识 | knowledge, knw, 智, 知, zs |
| 风度 | presence, pre, 魅, 风, fd |
| 灵巧 | finesse, fin, 巧, 灵, lq |
| 生命 | health, hp, 血, 命, sm, 生命值, 血量 |
| 压力 | stress, s, yl, 压力值 |
| 希望 | hope, h, xw, 希望值, 希望点 |
| 护甲 | armor, armour, a, hj, 防御 |
| 恐惧 | fear, f, kj, 恐惧值, 恐惧点 |
| 闪避 | evasion, e, sb, 回避, 闪, 避 |

---

## 自定义回复系统

插件提供了丰富的自定义回复选项，可在GUI的自定义回复面板中修改：

### .dd 命令相关
- `strDDResult`：二元骰检定结果格式
- `strDDError`：检定错误提示
- `strChallengeReason`：挑战原因文本
- `strHopeResult`：希望结果文本（支持`|`分隔的随机变体）
- `strFearResult`：恐惧结果文本（支持`|`分隔的随机变体）

### 修饰符和希望消耗相关
- `strModifiersDetail`：修饰符详情显示
- `strHopeConsume`：希望消耗显示（有上限）
- `strHopeConsumeNoMax`：希望消耗显示（无上限）
- `strHopeWarning`：希望不足警告
- `strHopeChange`：希望点变化显示（有上限）
- `strHopeChangeNoMax`：希望点变化显示（无上限）
- `strHopeAlreadyMax`：希望已达上限提示
- `strPressureChange`：压力变化显示（有上限）
- `strPressureChangeNoMax`：压力变化显示（无上限）
- `strPressureAlreadyZero`：压力已为0提示

### 帮助者相关
- `strHelperSuccess`：帮助成功提示
- `strHelperFailNoCard`：帮助失败-未找到人物卡
- `strHelperFailNoHope`：帮助失败-希望点不足

### .ddr 命令相关
- `strDDRResult`：反应二元骰检定结果格式

### GM管理命令相关
- `strGMSet`：设置GM成功
- `strGMDel`：卸任GM成功
- `strGMClear`：清除GM成功
- `strGMError`：GM管理错误
- `strGMFearIncrease`：GM恐惧点增加提示
- `strGMFearMax`：GM恐惧点达上限提示

### 烹饪游戏相关
- `strCookStart`：烹饪游戏开始
- `strCookContinue`：烹饪游戏继续
- `strCookEnd`：烹饪游戏结束
- `strCookError`：烹饪游戏错误
- `strCookScoreLow`：低分评价（支持`|`分隔的随机变体）
- `strCookScoreMid`：中等评价（支持`|`分隔的随机变体）
- `strCookScoreHigh`：高分评价（支持`|`分隔的随机变体）
- `strCookPairSuccess`：配对成功
- `strCookPairDetail`：配对详情
- `strCookPairNone`：无配对
- `strCookUnpaired`：未配对骰子
- `strCookAllUsed`：骰子用尽
- `strCookErrorFormat`：参数格式错误
- `strCookErrorNoGame`：无进行中游戏
- `strCookErrorNoDice`：无此骰面
- `strCookNextStep`：下一步提示

---

## 技术特性

### 数据存储
- GM数据：`plugin/data/OlivaDiceDH/{bot_hash}/GameMaster/{group_hash}.json`
- 烹饪数据：`plugin/data/OlivaDiceDH/{bot_hash}/Cook/{group_hash}.json`
- 人物卡数据：使用OlivaDiceCore标准存储

### 兼容性
- 完全兼容OlivaDiceCore标准人物卡系统
- 支持群组和频道的独立数据管理
- 自动名片更新集成

---

## 常见问题

**Q: 为什么我使用经历时提示"希望不足"？**
A: 每个经历修饰符需要消耗1点希望。请确保你的希望点充足，或者在检定前通过其他方式获得希望点。

**Q: 大成功时为什么压力没有减少？**
A: 请检查你的压力值是否已经为0。压力值不能为负数。

**Q: GM恐惧点如何使用？**
A: GM恐惧点由系统自动积累，GM可以在合适的时机使用恐惧点来强化敌人或创造困难情境（具体规则参考Daggerheart官方规则书）。

**Q: 优势和劣势如何计算？**
A: 所有优势和劣势先进行数量统计，然后相互抵消。剩余优势则投对应数量的d6取最高值；剩余劣势则投对应数量的d6取最高值后取负。

**Q: 可以同时使用多个修饰符吗？**
A: 可以！如：`.dd +力量+敏捷+2优势-劣势+5 #15`

---

## 联系与反馈

如有问题或建议，请联系作者：Desom-fu

---

## 使用截图
![Image description](https://forum.olivos.run/assets/files/2025-11-11/1762842105-534716-image.png)
![Image description](https://forum.olivos.run/assets/files/2025-11-11/1762842113-689113-image.png)
![Image description](https://forum.olivos.run/assets/files/2025-11-11/1762842120-859928-image.png)